{% extends "base.html" %}

{% block title %}Calendrier - {{ super() }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-calendar-alt me-2"></i>
            Calendrier financier
            <small class="text-muted">Planification et événements</small>
        </h1>
    </div>
</div>

<!-- Calendar Navigation -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-calendar me-2"></i>
                    <span id="currentMonth">{{ current_month }}</span> {{ current_year }}
                </h5>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary" onclick="previousMonth()">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="nextMonth()">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#eventModal">
                        <i class="fas fa-plus me-1"></i>
                        Nouvel événement
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="calendar" class="calendar-grid">
                    <!-- Calendar will be generated here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upcoming Events -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-clock me-2"></i>
                    Événements à venir
                </h5>
            </div>
            <div class="card-body">
                <div id="upcomingEvents">
                    <!-- Events will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>
                    Budget prévisionnel
                </h5>
            </div>
            <div class="card-body">
                <div id="budgetForecast">
                    <!-- Budget forecast will be shown here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Event Modal -->
<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-calendar-plus me-2"></i>
                    Nouvel événement
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="eventForm">
                    <div class="mb-3">
                        <label for="eventTitle" class="form-label">Titre</label>
                        <input type="text" class="form-control" id="eventTitle" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="eventDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="eventDate" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="eventDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="eventDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="eventBudget" class="form-label">Budget estimé (€)</label>
                        <input type="number" class="form-control" id="eventBudget" step="0.01" min="0">
                    </div>
                    
                    <div class="mb-3">
                        <label for="eventCategory" class="form-label">Catégorie</label>
                        <select class="form-select" id="eventCategory">
                            <option value="">Sélectionner une catégorie</option>
                        </select>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="eventVacationMode">
                        <label class="form-check-label" for="eventVacationMode">
                            Mode vacances
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="saveEvent()">Enregistrer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentDate = new Date();
let events = [];

document.addEventListener('DOMContentLoaded', function() {
    loadCalendar();
    loadEvents();
    loadCategories();
});

function loadCalendar() {
    const calendar = document.getElementById('calendar');
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    
    // Update month display
    const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin',
                       'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
    document.getElementById('currentMonth').textContent = monthNames[month];
    
    calendar.innerHTML = generateCalendarHTML(year, month);
}

function generateCalendarHTML(year, month) {
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDay = firstDay.getDay();
    
    let html = '<div class="calendar-header">';
    const dayNames = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
    dayNames.forEach(day => {
        html += `<div class="calendar-day-header">${day}</div>`;
    });
    html += '</div><div class="calendar-body">';
    
    // Empty cells for days before the first day of the month
    for (let i = 0; i < startingDay; i++) {
        html += '<div class="calendar-day empty"></div>';
    }
    
    // Days of the month
    for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const isToday = date.toDateString() === new Date().toDateString();
        const dayEvents = events.filter(event => 
            new Date(event.date).toDateString() === date.toDateString()
        );
        
        html += `<div class="calendar-day ${isToday ? 'today' : ''}" data-date="${date.toISOString().split('T')[0]}">`;
        html += `<span class="day-number">${day}</span>`;
        
        if (dayEvents.length > 0) {
            html += `<div class="day-events">`;
            dayEvents.forEach(event => {
                html += `<div class="calendar-event-dot" title="${event.title}"></div>`;
            });
            html += `</div>`;
        }
        
        html += '</div>';
    }
    
    html += '</div>';
    return html;
}

function previousMonth() {
    currentDate.setMonth(currentDate.getMonth() - 1);
    loadCalendar();
}

function nextMonth() {
    currentDate.setMonth(currentDate.getMonth() + 1);
    loadCalendar();
}

async function loadEvents() {
    try {
        const startDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
        const endDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
        
        const response = await fetch(`/api/calendar/events?start_date=${startDate.toISOString().split('T')[0]}&end_date=${endDate.toISOString().split('T')[0]}`);
        const data = await response.json();
        events = data.events;
        
        loadCalendar(); // Refresh calendar with events
        displayUpcomingEvents();
    } catch (error) {
        console.error('Error loading events:', error);
    }
}

function displayUpcomingEvents() {
    const container = document.getElementById('upcomingEvents');
    const upcoming = events.filter(event => new Date(event.date) >= new Date())
                           .sort((a, b) => new Date(a.date) - new Date(b.date))
                           .slice(0, 5);
    
    if (upcoming.length === 0) {
        container.innerHTML = '<p class="text-muted">Aucun événement à venir</p>';
        return;
    }
    
    container.innerHTML = upcoming.map(event => `
        <div class="calendar-event ${event.is_vacation_mode ? 'vacation-mode' : ''}">
            <strong>${event.title}</strong>
            <small class="text-muted d-block">${new Date(event.date).toLocaleDateString('fr-FR')}</small>
            ${event.estimated_budget ? `<small class="text-primary">Budget: ${event.estimated_budget}€</small>` : ''}
        </div>
    `).join('');
}

async function loadCategories() {
    if (window.expenseApp && window.expenseApp.categories) {
        const select = document.getElementById('eventCategory');
        window.expenseApp.categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            select.appendChild(option);
        });
    }
}

async function saveEvent() {
    const form = document.getElementById('eventForm');
    const formData = new FormData(form);
    
    const eventData = {
        title: document.getElementById('eventTitle').value,
        date: document.getElementById('eventDate').value,
        description: document.getElementById('eventDescription').value,
        estimated_budget: document.getElementById('eventBudget').value || null,
        category_id: document.getElementById('eventCategory').value || null,
        is_vacation_mode: document.getElementById('eventVacationMode').checked
    };
    
    try {
        const response = await fetch('/api/calendar/events', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(eventData)
        });
        
        const result = await response.json();
        if (result.success) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('eventModal'));
            modal.hide();
            form.reset();
            loadEvents();
            
            if (window.expenseApp) {
                window.expenseApp.showToast('success', 'Événement créé avec succès !');
            }
        }
    } catch (error) {
        console.error('Error saving event:', error);
        if (window.expenseApp) {
            window.expenseApp.showToast('error', 'Erreur lors de la création de l\'événement');
        }
    }
}
</script>

<style>
.calendar-grid {
    display: grid;
    grid-template-rows: auto 1fr;
    min-height: 400px;
}

.calendar-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: #ddd;
    border-radius: 8px 8px 0 0;
}

.calendar-day-header {
    background: var(--primary-color);
    color: white;
    padding: 0.75rem;
    text-align: center;
    font-weight: 600;
}

.calendar-body {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: #ddd;
    border-radius: 0 0 8px 8px;
}

.calendar-day {
    background: var(--card-bg);
    min-height: 80px;
    padding: 0.5rem;
    position: relative;
    cursor: pointer;
    transition: var(--transition);
}

.calendar-day:hover {
    background: rgba(102, 126, 234, 0.1);
}

.calendar-day.empty {
    background: transparent;
    cursor: default;
}

.calendar-day.today {
    background: rgba(102, 126, 234, 0.2);
    font-weight: bold;
}

.day-number {
    font-size: 0.9rem;
    font-weight: 500;
}

.day-events {
    margin-top: 0.25rem;
}

.calendar-event-dot {
    width: 6px;
    height: 6px;
    background: var(--primary-color);
    border-radius: 50%;
    display: inline-block;
    margin: 1px;
}
</style>
{% endblock %}