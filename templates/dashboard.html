{% extends "base.html" %}

{% block title %}Tableau de bord - {{ super() }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-chart-pie me-2"></i>
            Tableau de bord
            <small class="text-muted">Vue d'ensemble de vos finances</small>
        </h1>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stats-card income">
            <i class="fas fa-money-bill-wave fa-2x mb-2 text-success"></i>
            <div class="stats-value">{{ "%.2f"|format(monthly_income) }}€</div>
            <div class="stats-label">Revenus du mois</div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stats-card expense">
            <i class="fas fa-receipt fa-2x mb-2 text-danger"></i>
            <div class="stats-value">{{ "%.2f"|format(monthly_expenses) }}€</div>
            <div class="stats-label">Dépenses du mois</div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stats-card">
            <i class="fas fa-sync-alt fa-2x mb-2 text-info"></i>
            <div class="stats-value">{{ "%.2f"|format(monthly_subscriptions) }}€</div>
            <div class="stats-label">Abonnements mensuels</div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stats-card remaining {% if remaining_budget >= 0 %}income{% else %}expense{% endif %}">
            <i class="fas fa-piggy-bank fa-2x mb-2 {% if remaining_budget >= 0 %}text-success{% else %}text-danger{% endif %}"></i>
            <div class="stats-value">{{ "%.2f"|format(remaining_budget) }}€</div>
            <div class="stats-label">Reste à vivre</div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-lg-8 mb-3">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    Évolution des dépenses
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="expensesChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 mb-3">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Répartition par catégorie
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="categoriesChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity and Upcoming -->
<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-clock me-2"></i>
                    Dépenses récentes
                </h5>
                <a href="{{ url_for('expenses') }}" class="btn btn-sm btn-outline-primary">
                    Voir tout
                </a>
            </div>
            <div class="card-body">
                {% if recent_expenses %}
                    {% for expense in recent_expenses %}
                    <div class="expense-item {% if expense.is_exceptional %}exceptional{% endif %}">
                        <div class="category-icon" style="background: {{ expense.category.color }};">
                            <i class="{{ expense.category.icon }}"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">{{ expense.description }}</h6>
                                    <small class="text-muted">
                                        {{ expense.category.name }} • 
                                        {{ expense.date.strftime('%d/%m/%Y') }}
                                        {% if expense.is_exceptional %}
                                        <span class="badge bg-warning ms-1">Exceptionnel</span>
                                        {% endif %}
                                    </small>
                                </div>
                                <span class="fw-bold text-danger">-{{ "%.2f"|format(expense.amount) }}€</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-receipt fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Aucune dépense récente</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#quickAddModal">
                            <i class="fas fa-plus me-1"></i>
                            Ajouter une dépense
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-alt me-2"></i>
                    Abonnements à renouveler
                </h5>
                <a href="{{ url_for('subscriptions') }}" class="btn btn-sm btn-outline-primary">
                    Gérer
                </a>
            </div>
            <div class="card-body">
                {% if upcoming_subs %}
                    {% for subscription in upcoming_subs %}
                    <div class="d-flex justify-content-between align-items-center mb-3 p-3 border-start border-4 {% if subscription.billing_cycle == 'monthly' %}border-success{% else %}border-primary{% endif %} bg-light rounded">
                        <div>
                            <h6 class="mb-1">{{ subscription.name }}</h6>
                            <small class="text-muted">
                                {{ subscription.category.name }} • 
                                {{ subscription.next_billing.strftime('%d/%m/%Y') }}
                                <span class="badge {% if subscription.billing_cycle == 'monthly' %}bg-success{% else %}bg-primary{% endif %} ms-1">
                                    {{ 'Mensuel' if subscription.billing_cycle == 'monthly' else 'Annuel' }}
                                </span>
                            </small>
                        </div>
                        <div class="text-end">
                            <span class="fw-bold">{{ "%.2f"|format(subscription.amount) }}€</span>
                            {% if subscription.next_billing <= date(2024, 1, 1) %}
                            <br><small class="text-danger"><i class="fas fa-exclamation-triangle"></i> En retard</small>
                            {% elif (subscription.next_billing - date.today()).days <= 3 %}
                            <br><small class="text-warning"><i class="fas fa-clock"></i> Bientôt</small>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-sync-alt fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Aucun abonnement à renouveler prochainement</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#quickAddModal" 
                                onclick="document.querySelector('#subscription-tab').click()">
                            <i class="fas fa-plus me-1"></i>
                            Ajouter un abonnement
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Challenges Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-trophy me-2"></i>
                    Défis du mois
                </h5>
                <button class="btn btn-sm btn-outline-primary" onclick="createNewChallenge()">
                    <i class="fas fa-plus me-1"></i>
                    Nouveau défi
                </button>
            </div>
            <div class="card-body">
                <div class="row" id="challengesContainer">
                    <!-- Challenges will be loaded here -->
                    <div class="col-12 text-center py-4">
                        <i class="fas fa-spinner fa-spin fa-2x text-muted mb-3"></i>
                        <p class="text-muted">Chargement des défis...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Badges Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-medal me-2"></i>
                    Badges et récompenses
                </h5>
            </div>
            <div class="card-body">
                <div class="row" id="badgesContainer">
                    <!-- Badges will be loaded here -->
                    <div class="col-12 text-center py-4">
                        <i class="fas fa-spinner fa-spin fa-2x text-muted mb-3"></i>
                        <p class="text-muted">Chargement des badges...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- PWA Install Banner -->
<div class="row mb-4" id="installBanner" style="display: none;">
    <div class="col-12">
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            <i class="fas fa-mobile-alt me-2"></i>
            <strong>Installer l'application !</strong> 
            Ajoutez Dépenses Couple à votre écran d'accueil pour un accès rapide et des notifications.
            <button type="button" class="btn btn-sm btn-primary ms-2" id="installApp" style="display: none;">
                Installer
            </button>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-bolt me-2"></i>
                    Actions rapides
                </h5>
                <div class="btn-group" role="group">
                    <button class="btn btn-sm btn-outline-info" onclick="expenseApp.createBackup()" title="Sauvegarder les données">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-warning" onclick="toggleVacationMode()" title="Mode vacances">
                        <i class="fas fa-umbrella-beach"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3 col-6 mb-3">
                        <button class="btn btn-outline-primary w-100 py-3" data-bs-toggle="modal" data-bs-target="#quickAddModal">
                            <i class="fas fa-receipt fa-2x mb-2"></i>
                            <br>Nouvelle dépense
                        </button>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <button class="btn btn-outline-success w-100 py-3" data-bs-toggle="modal" data-bs-target="#quickAddModal"
                                onclick="document.querySelector('#income-tab').click()">
                            <i class="fas fa-money-bill-wave fa-2x mb-2"></i>
                            <br>Nouveau revenu
                        </button>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <button class="btn btn-outline-info w-100 py-3" data-bs-toggle="modal" data-bs-target="#quickAddModal"
                                onclick="document.querySelector('#subscription-tab').click()">
                            <i class="fas fa-sync-alt fa-2x mb-2"></i>
                            <br>Nouvel abonnement
                        </button>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <a href="{{ url_for('budgets') }}" class="btn btn-outline-warning w-100 py-3">
                            <i class="fas fa-piggy-bank fa-2x mb-2"></i>
                            <br>Gérer budgets
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Add custom dashboard scripts if needed
    document.addEventListener('DOMContentLoaded', function() {
        // Add pulse animation to remaining budget if negative
        const remainingBudget = {{ remaining_budget }};
        if (remainingBudget < 0) {
            document.querySelector('.stats-card.remaining').classList.add('pulse');
        }
        
        // Add warning tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Show install banner after a delay
        setTimeout(() => {
            const installBanner = document.getElementById('installBanner');
            if (installBanner && !localStorage.getItem('installBannerDismissed')) {
                installBanner.style.display = 'block';
            }
        }, 3000);
    });
    
    function createNewChallenge() {
        // Simple challenge creation - in real app would be a modal
        const challengeData = {
            name: 'Défi Économie',
            description: 'Réduire les dépenses de divertissement de 20%',
            category_id: 4, // Divertissement
            target_amount: 150,
            target_type: 'reduce'
        };
        
        if (window.expenseApp) {
            window.expenseApp.createChallenge(challengeData);
        }
    }
    
    function toggleVacationMode() {
        const isVacationMode = localStorage.getItem('vacationMode') === 'true';
        
        if (isVacationMode) {
            localStorage.removeItem('vacationMode');
            document.body.classList.remove('vacation-mode');
            window.expenseApp.showToast('info', 'Mode vacances désactivé');
        } else {
            localStorage.setItem('vacationMode', 'true');
            document.body.classList.add('vacation-mode');
            window.expenseApp.showToast('success', 'Mode vacances activé - Interface simplifiée');
        }
    }
    });
</script>
{% endblock %}