{% extends "base.html" %}

{% block title %}Budgets - {{ super() }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="mb-0">
                <i class="fas fa-piggy-bank me-2"></i>
                Gestion des budgets
            </h1>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#budgetModal">
                <i class="fas fa-plus me-1"></i>
                Nouveau budget
            </button>
        </div>
    </div>
</div>

<!-- Budget Overview -->
{% if budget_data %}
<div class="row mb-4">
    {% set total_budget = budget_data | sum(attribute='budget.monthly_limit') %}
    {% set total_spent = budget_data | sum(attribute='spent') %}
    {% set budget_percentage = (total_spent / total_budget * 100) if total_budget > 0 else 0 %}
    
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <h5 class="text-primary">Budget total</h5>
                        <span class="fs-4 fw-bold">{{ "%.2f"|format(total_budget) }}€</span>
                    </div>
                    <div class="col-md-3">
                        <h5 class="text-primary">Dépensé</h5>
                        <span class="fs-4 fw-bold text-danger">{{ "%.2f"|format(total_spent) }}€</span>
                    </div>
                    <div class="col-md-3">
                        <h5 class="text-primary">Restant</h5>
                        <span class="fs-4 fw-bold {% if total_budget - total_spent >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {{ "%.2f"|format(total_budget - total_spent) }}€
                        </span>
                    </div>
                    <div class="col-md-3">
                        <h5 class="text-primary">Utilisation</h5>
                        <span class="fs-4 fw-bold {% if budget_percentage <= 80 %}text-success{% elif budget_percentage <= 95 %}text-warning{% else %}text-danger{% endif %}">
                            {{ "%.1f"|format(budget_percentage) }}%
                        </span>
                    </div>
                </div>
                
                <div class="mt-4">
                    <div class="d-flex justify-content-between text-muted small mb-2">
                        <span>Progression globale</span>
                        <span>{{ "%.2f"|format(total_spent) }}€ / {{ "%.2f"|format(total_budget) }}€</span>
                    </div>
                    <div class="progress" style="height: 12px;">
                        <div class="progress-bar {% if budget_percentage <= 80 %}bg-success{% elif budget_percentage <= 95 %}bg-warning{% else %}bg-danger{% endif %}" 
                             style="width: {{ budget_percentage if budget_percentage <= 100 else 100 }}%">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Budget Categories -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>
                    Budgets par catégorie
                </h5>
                <div class="text-muted">
                    {{ budget_data | length }} catégorie{{ 's' if budget_data | length > 1 else '' }} budgétée{{ 's' if budget_data | length > 1 else '' }}
                </div>
            </div>
            <div class="card-body">
                {% if budget_data %}
                <div class="row">
                    {% for data in budget_data %}
                    {% set percentage = data.percentage %}
                    {% set budget = data.budget %}
                    {% set spent = data.spent %}
                    
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100 budget-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div class="d-flex align-items-center">
                                        <div class="category-icon me-3" style="background: {{ budget.category.color }};">
                                            <i class="{{ budget.category.icon }}"></i>
                                        </div>
                                        <div>
                                            <h6 class="card-title mb-1">{{ budget.category.name }}</h6>
                                            <small class="text-muted">Budget mensuel</small>
                                        </div>
                                    </div>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary" type="button" 
                                                data-bs-toggle="dropdown">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li>
                                                <a class="dropdown-item" href="#" onclick="editBudget({{ budget.id }}, '{{ budget.category.name }}', {{ budget.monthly_limit }})">
                                                    <i class="fas fa-edit me-2"></i>Modifier
                                                </a>
                                            </li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <a class="dropdown-item text-danger" href="#" onclick="deleteBudget({{ budget.id }})">
                                                    <i class="fas fa-trash me-2"></i>Supprimer
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="text-muted">Budget alloué</span>
                                        <span class="fw-bold">{{ "%.2f"|format(budget.monthly_limit) }}€</span>
                                    </div>
                                    
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="text-muted">Dépensé</span>
                                        <span class="fw-bold text-danger">{{ "%.2f"|format(spent) }}€</span>
                                    </div>
                                    
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-muted">Restant</span>
                                        <span class="fw-bold {% if budget.monthly_limit - spent >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ "%.2f"|format(budget.monthly_limit - spent) }}€
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between text-muted small mb-2">
                                        <span>Utilisation du budget</span>
                                        <span>{{ "%.1f"|format(percentage) }}%</span>
                                    </div>
                                    <div class="progress" style="height: 10px;">
                                        <div class="progress-bar 
                                            {% if percentage <= 60 %}bg-success
                                            {% elif percentage <= 80 %}bg-info
                                            {% elif percentage <= 95 %}bg-warning
                                            {% else %}bg-danger{% endif %}" 
                                             style="width: {{ percentage if percentage <= 100 else 100 }}%">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Budget Alert -->
                                {% if percentage > 100 %}
                                <div class="budget-alert danger">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Budget dépassé !</strong> Vous avez dépensé {{ "%.2f"|format(spent - budget.monthly_limit) }}€ de plus que prévu.
                                </div>
                                {% elif percentage > 80 %}
                                <div class="budget-alert warning">
                                    <i class="fas fa-exclamation-circle me-2"></i>
                                    <strong>Attention !</strong> Vous avez utilisé plus de 80% de votre budget.
                                </div>
                                {% elif percentage > 60 %}
                                <div class="budget-alert success">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Bon suivi !</strong> Vous êtes dans les temps avec votre budget.
                                </div>
                                {% endif %}
                                
                                <!-- Daily spending recommendation -->
                                {% set days_in_month = 30 %}
                                {% set today = moment().day %}
                                {% set days_remaining = days_in_month - today %}
                                {% set remaining_budget = budget.monthly_limit - spent %}
                                {% set daily_budget = (remaining_budget / days_remaining) if days_remaining > 0 else 0 %}
                                
                                {% if days_remaining > 0 and remaining_budget > 0 %}
                                <div class="text-center mt-3 p-2 bg-light rounded">
                                    <small class="text-muted">
                                        <i class="fas fa-lightbulb me-1"></i>
                                        Recommandation : {{ "%.2f"|format(daily_budget) }}€/jour pendant {{ days_remaining }} jours
                                    </small>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-piggy-bank fa-4x text-muted mb-4"></i>
                    <h4>Aucun budget configuré</h4>
                    <p class="text-muted mb-4">
                        Créez des budgets par catégorie pour mieux contrôler vos dépenses.
                    </p>
                    <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#budgetModal">
                        <i class="fas fa-plus me-2"></i>
                        Créer un budget
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Available Categories (for budgets not set) -->
{% if categories %}
{% set budgeted_categories = budget_data | map(attribute='budget.category_id') | list %}
{% set available_categories = categories | rejectattr('id', 'in', budgeted_categories) | list %}

{% if available_categories %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-plus-circle me-2"></i>
                    Catégories sans budget
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">Ces catégories n'ont pas encore de budget défini :</p>
                <div class="row">
                    {% for category in available_categories %}
                    <div class="col-md-4 col-sm-6 mb-3">
                        <div class="d-flex align-items-center p-3 border rounded cursor-pointer" 
                             onclick="addBudgetForCategory({{ category.id }}, '{{ category.name }}')">
                            <div class="category-icon me-3" style="background: {{ category.color }};">
                                <i class="{{ category.icon }}"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-0">{{ category.name }}</h6>
                                <small class="text-muted">Cliquez pour ajouter un budget</small>
                            </div>
                            <i class="fas fa-plus text-primary"></i>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endif %}

<!-- Budget Modal -->
<div class="modal fade" id="budgetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="budgetModalTitle">Nouveau budget</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="budgetForm">
                    <input type="hidden" id="budgetId">
                    
                    <div class="mb-3">
                        <label for="budgetCategory" class="form-label">Catégorie</label>
                        <select class="form-select" id="budgetCategory" required>
                            <option value="">Choisir une catégorie</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}" data-color="{{ category.color }}" data-icon="{{ category.icon }}">
                                {{ category.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="budgetAmount" class="form-label">Budget mensuel (€)</label>
                        <input type="number" class="form-control" id="budgetAmount" step="0.01" min="0" required>
                        <div class="form-text">Montant que vous souhaitez allouer à cette catégorie chaque mois.</div>
                    </div>
                    
                    <!-- Budget suggestions -->
                    <div class="mb-3">
                        <label class="form-label">Suggestions</label>
                        <div class="d-flex gap-2 flex-wrap">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setBudgetAmount(50)">50€</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setBudgetAmount(100)">100€</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setBudgetAmount(200)">200€</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setBudgetAmount(300)">300€</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setBudgetAmount(500)">500€</button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="saveBudget">Enregistrer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Budget management functions
    function setBudgetAmount(amount) {
        document.getElementById('budgetAmount').value = amount;
    }
    
    function addBudgetForCategory(categoryId, categoryName) {
        document.getElementById('budgetModalTitle').textContent = `Budget pour ${categoryName}`;
        document.getElementById('budgetCategory').value = categoryId;
        document.getElementById('budgetCategory').disabled = true;
        document.getElementById('budgetId').value = '';
        document.getElementById('budgetAmount').value = '';
        
        const modal = new bootstrap.Modal(document.getElementById('budgetModal'));
        modal.show();
    }
    
    function editBudget(budgetId, categoryName, currentAmount) {
        document.getElementById('budgetModalTitle').textContent = `Modifier le budget ${categoryName}`;
        document.getElementById('budgetId').value = budgetId;
        document.getElementById('budgetAmount').value = currentAmount;
        document.getElementById('budgetCategory').disabled = true;
        
        const modal = new bootstrap.Modal(document.getElementById('budgetModal'));
        modal.show();
    }
    
    async function deleteBudget(budgetId) {
        if (!confirm('Êtes-vous sûr de vouloir supprimer ce budget ?')) return;
        
        try {
            const response = await fetch(`/api/budgets/${budgetId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                location.reload();
            } else {
                alert('Erreur lors de la suppression');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Erreur de connexion');
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        // Save budget
        document.getElementById('saveBudget').addEventListener('click', async function() {
            const form = document.getElementById('budgetForm');
            const formData = new FormData(form);
            
            const data = {
                category_id: document.getElementById('budgetCategory').value,
                monthly_limit: document.getElementById('budgetAmount').value
            };
            
            try {
                const response = await fetch('/api/budgets', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    window.expenseApp.showToast('success', result.message);
                    bootstrap.Modal.getInstance(document.getElementById('budgetModal')).hide();
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    window.expenseApp.showToast('error', result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                window.expenseApp.showToast('error', 'Erreur de connexion');
            }
        });
        
        // Reset modal on hide
        document.getElementById('budgetModal').addEventListener('hidden.bs.modal', function() {
            document.getElementById('budgetForm').reset();
            document.getElementById('budgetCategory').disabled = false;
            document.getElementById('budgetModalTitle').textContent = 'Nouveau budget';
        });
        
        // Animate budget cards
        document.querySelectorAll('.budget-card').forEach((card, index) => {
            setTimeout(() => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                card.style.transition = 'all 0.5s ease';
                
                requestAnimationFrame(() => {
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                });
            }, index * 100);
        });
        
        // Animate progress bars
        setTimeout(() => {
            document.querySelectorAll('.progress-bar').forEach(bar => {
                const width = bar.style.width;
                bar.style.width = '0%';
                bar.style.transition = 'width 1.5s ease';
                
                setTimeout(() => {
                    bar.style.width = width;
                }, 200);
            });
        }, 300);
    });
</script>
{% endblock %}